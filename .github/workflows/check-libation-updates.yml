# This workflow checks for new Libation releases and creates a pull request to update the version
name: Check Libation Updates

on:
  schedule:
    # Run daily at 2 AM UTC to check for new releases
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
#        with:
#          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get latest Libation release
        id: latest-release
        run: |
          # Fetch the latest release from rmcrackan/Libation
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/rmcrackan/Libation/releases/latest | jq -r '.tag_name' | sed 's/v//')
          echo "latest_version=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          echo "Latest Libation version: $LATEST_RELEASE"
      
      - name: Get current version from build.yml
        id: current-version
        run: |
          CURRENT_VERSION=$(grep 'LIBATION_VERSION:' .github/workflows/build.yml | head -1 | awk '{print $2}')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version in workflow: $CURRENT_VERSION"
      
      - name: Compare versions
        id: compare
        run: |
          LATEST="${{ steps.latest-release.outputs.latest_version }}"
          CURRENT="${{ steps.current-version.outputs.current_version }}"
          
          if [ "$LATEST" != "$CURRENT" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Version mismatch detected: Current=$CURRENT, Latest=$LATEST"
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "Versions match, no update needed"
          fi
      
      - name: Update build.yml
        if: steps.compare.outputs.update_needed == 'true'
        run: |
          LATEST="${{ steps.latest-release.outputs.latest_version }}"
          # Update LIBATION_VERSION in build.yml
          sed -i "s/LIBATION_VERSION: .*/LIBATION_VERSION: $LATEST/" .github/workflows/build.yml
          echo "Updated build.yml with version $LATEST"
      
      - name: Update Dockerfile
        if: steps.compare.outputs.update_needed == 'true'
        run: |
          LATEST="${{ steps.latest-release.outputs.latest_version }}"
          # Update GIT_TAG default in Dockerfile
          sed -i "s/ARG GIT_TAG=\${GIT_TAG:-.*}/ARG GIT_TAG=\${GIT_TAG:-$LATEST}/" Dockerfile
          echo "Updated Dockerfile with version $LATEST"
      
      - name: Create Pull Request
        if: steps.compare.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Update Libation to version ${{ steps.latest-release.outputs.latest_version }}"
          title: "chore: Update Libation to version ${{ steps.latest-release.outputs.latest_version }}"
          body: |
            ## Update Libation Version
            
            Updates Libation to the latest available version.
            
            **Changes:**
            - Updated `LIBATION_VERSION` in `.github/workflows/build.yml`
            - Updated `GIT_TAG` default in `Dockerfile`
            
            **Current version:** ${{ steps.current-version.outputs.current_version }}
            **New version:** ${{ steps.latest-release.outputs.latest_version }}
            
            This PR was automatically generated by the "Check Libation Updates" workflow.
          branch: update/libation-${{ steps.latest-release.outputs.latest_version }}
          delete-branch: true
          labels: |
            automation
            dependencies

# .github/workflows/libation-guard.yml
name: libation-guard
on:
  push:
  pull_request:
  schedule:
    - cron: "0 7 * * 1"  # Mondays 07:00 UTC

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: pinned
        name: Extract pinned Libation version
        run: |
          v=$(grep -Eo 'ARG[[:space:]]+LIBATION_VERSION[[:space:]]*=[[:space:]]*"?[0-9]+\.[0-9]+\.[0-9]+' Dockerfile \
              | sed 's/.*=//; s/"//g; s/ //g')
          echo "version=$v" >> "$GITHUB_OUTPUT"

      - id: latest
        name: Get latest Libation version
        run: |
          latest=$(curl -fsSL -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/rmcrackan/Libation/releases/latest | jq -r .tag_name)
          echo "version=${latest#v}" >> "$GITHUB_OUTPUT"

      - name: Enforce newest
        env:
          PINNED: ${{ steps.pinned.outputs.version }}
          LATEST: ${{ steps.latest.outputs.version }}
        run: |
          test "$PINNED" = "$LATEST" || {
            echo "::error::Not on latest Libation ($PINNED != $LATEST). Bump ARG LIBATION_VERSION.";
            exit 1
          }
